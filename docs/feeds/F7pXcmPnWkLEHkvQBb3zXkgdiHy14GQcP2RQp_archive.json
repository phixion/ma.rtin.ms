{"id":"F7pXcmPnWkLEHkvQBb3zXkgdiHy14GQcP2RQp","title":"Aphyr: Posts","displayTitle":"Dev - Aphyr","url":"http://aphyr.com/posts.atom","feedLink":"http://aphyr.com/posts.atom","isQuery":false,"isEmpty":false,"isHidden":false,"itemCount":1,"items":[{"title":"Geoblocking Multiple Localities With Nginx","url":"https://aphyr.com/posts/395-geoblocking-multiple-localities-with-nginx","date":1760183605,"author":"Aphyr","guid":396,"unread":true,"content":"<p>Now Mississippi’s 2024 HB 1126 has made it illegal for essentially any web site to know a user’s e-mail address, or other “personal identifying information”, unless that site also takes steps to \"verify the age of the person creating an account”. Bluesky <a href=\"https://bsky.social/about/blog/08-22-2025-mississippi-hb1126\">wound up geoblocking Mississippi</a>. Over on a small forum I help run, we paid our lawyers to look into HB 1126, and the conclusion was that we were <a href=\"https://blog.woof.group/announcements/woof-group-will-block-mississippi\">likely in the same boat</a>. Collecting email addresses put us in scope of the bill, and it wasn’t clear whether the LLC would shield officers (hi) from personal liability.</p><p>This blog has the same problem: people use email addresses to post and confirm their comments. I think my personal blog is probably at low risk, but a.) I’d like to draw attention to this legislation, and b.) my risk is elevated by being gay online, and having written and called a whole bunch of Mississippi legislators about HB 1126. Long story short, I’d like to block both a country  an individual state. Here’s how:</p><p>First, set up <a href=\"https://aphyr.com/posts/379-geoblocking-the-uk-with-debian-nginx\">geoipupdate as before</a>. Then, in <code>/etc/nginx/conf.d.geoblock.conf</code>, pull in the country and city databases, and map the countries and states you’d like to block to short strings explaining the applicable law. This creates variables  and .</p><pre><code></code></pre><p>Create an HTML page to show to geoblocked IPs. I’ve put mine in <code>/var/www/custom_errors/451.html</code>. The special comments here are Server-Side Include (SSI) directives; they’ll insert the contents of the  variable from nginx, which we’ll set shortly.</p><pre><code>Unavailable Due to\n      Unavailable Due to\n      </code></pre><p>Then, in <code>/etc/nginx/sites-enabled/whatever.conf</code>, add an error page for status code <a href=\"https://en.wikipedia.org/wiki/HTTP_451\">451 (unavailable for legal reasons)</a>. In the main  block, check the  and  variables, and use them to return status 451, and set the  variable for the SSI template:</p><pre><code></code></pre><p>Test with , and reload with , as usual.</p><p>Geoblocking is a bad experience in general. In Amsterdam and Frankfurt, I’ve seen my cell phone’s 5G connection and hotel WiFi improperly identified as being in the UK. I’m certain this is going to block people who aren’t in Mississippi. If you don’t want to live in this world either, start <a href=\"https://5calls.org/why-calling-works/\">calling your representatives</a> to demand better legislation.</p>","contentLength":2204,"flags":null,"enclosureUrl":"","enclosureMime":"","commentsUrl":null}],"tags":["dev"]}